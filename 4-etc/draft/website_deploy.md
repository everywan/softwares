# 瞎搞瞎玩网站部署经历
PS: TMD, 再也不写前端了, 各种没意思的坑.

涉及 
1. oss
2. cdn
3. nginx
4. cname
5. ssl证书

## 起始
一直以来, 都想写个自己的网站, 实践下完整的部署流程, 包括cdn什么的(之前只是push程序到服务器, 然后运行托管就完了, 没有深入到每个流程, 即从开发, 构建, 部署, 优化/cdn等)

拖了好久, 终于在上个月决定趁业余时间好好整下.

## 确认需求
这个, 是前期对我最大的挑战...

技术上, 有不会的, 去查, 去学就ok了, 但是需求这个, 没有确定的答案. 从刚开始写, 到现在, 我已经改需求改得自己都傻逼了. 总结下, 大概源于如下原因
1. 没有考虑清楚自己的真实需求
2. 把只是觉得好玩, 想试下的功能, 当成自己的需求, 并且这种拍脑子的功能, 没有经过深思熟虑导致前端逻辑展示上不完善, 易变, 从而使自己疲于奔命.
3. 前端, 对我而言, 真的不合适, 没那么好玩, 不想深入. 有时候, 对于这些代码, 不应该强加完美主义倾向吧.

学到的知识
1. 技术上的
2. 给自己的前端/后端/部署添加了demo和容器. 如此, 以后不论是需要参考, 还是有好玩的想法, 都可以用到.
3. 渐进式开发, 逐渐挖掘需求, 同时也要注意, 不要被迷惑, 要清楚到底是不是想要的, 还是想玩的.

最终, 确认需求如下, 需要的网页为
1. tools: 一些常用的功能, 如在线 markdown 编辑, ip获取等, 不定期更新.
2. 主站, 主要分为网站能力和具体页面
  - 网站能力: 借助markdown实现的 文件预览, 编辑, 文件夹预览.
  - 网站能力: commandbar: 参考 chrome-cvim 实现的快捷命令, 作为全站的主要跳转工具
  - home: 展示主页面, 提供使用说明, 导航与介绍等.
  - resume: 文件夹, 存放多种用途的简历

待做如下
1. 主站
  - feed流支持, 支持同步到微信公众号
2. cloud file manager: 与现在的 filebrowser 有重复, 即一个web端的, 文件管理工具
  - 支持 CURD 和 预览, 必须支持 markdown
  - 支持私有和公有, 及 private/public
  - 支持用户认证
  - 待定: 支持shell
3. 好玩的: 用户认证
  - OA

## 开发流程
工具:
1. 代码组织
  - *github 组织*: 创建组织, 而非在自己账户上开发
  - git flow
2. 后端: go
3. 前端: vue + ts + tsx + etc
4. 部署: docker+nginx

开发过程不再叙述. 其中, github 组织 是一个很好的功能, 之前我没有意识到, 希望大家也考虑下这玩意.

关于文件的处理, 为什么说后端返回 url 比直接返回 content 好:
1. 分布式部署: 文件存储节点可以接入oss等, 实现就近访问, 而服务分散部署则比较麻烦
2. 根据特点优化: 文件下载所需流量和计算 与 服务不同, 分开可以更好的针对其特性优化, 如加大带宽等
3. 服务解耦: 避免因文件操作导致主服务挂掉


## 部署
这个也是一把泪啊, 兜兜转转最后还是回到了原点.

最大的教训就是
1. 如果你想少吃苦, 就先把简单的做出来, 然后再优化
2. 如果你想更有挑战些, 或者不怕吃苦, 可以试试想一部登天的感觉

为什么这么说呢, 因为我选的第二个.

先说下这里我学到的知识吧(按用到的顺序)
1. oss: oss很强, 支持静态网站托管, 支持外链访问
2. cdn: Content Delivery Network, 内容分发网络.
  - CDN是构建在现有网络基础之上的智能虚拟网络, 依靠部署在各地的边缘服务器, 通过中心平台的负载均衡/内容分发/调度等功能模块, 使用户就近获取所需内容, 降低网络拥塞, 提高用户访问响应速度和命中率. CDN的关键技术主要有内容存储和分发技术.
3. cname: A记录将一个域名解析到一个IP地址,  CNAME将一个域名解析到另一个域名.
4. https
  - 踩坑1: https页面不能访问http页面
5. nginx: 又温习了遍 nginx 的入门使用, 基础使用详见 docker/nginx.

在开始部署前, 我申请了几个ssl证书, 当时是想充分拆分路由, 后来发现, 人穷客少的情况下, 做不来. ssl证书域名如下
1. cloud.xx.com
2. api.xx.com
3. xx.com

先说下oss
1. oss支持静态网页托管, 但是, TMD SPA网页不能使用这种方式, 因为 oss 只是简单的路径映射, vuerouter 的history 模式对其无效, 所以最终还是使用nginx代理了.
  - 由于我只有一台服务器, 所以只有一个 443 端口, 所以我的证书白申请了, 这是想 一步登天却被坑 的第一步.
2. 在 vue 中设置 publicPath 为 oss 路径, 生成的静态资源路径就指向oss, 但是, TMD, 如此导致了vue中, 执行 `this.$router.push()` 时, 跟路径为 oss url, 导致每次push都将 oss-url 添加到url后, 导致错误.
3. 在使用oss托管网站时, 我考察了阿里的cdn, 因为大陆都需要备案, 所以只能用海外的cdn, 测了下发现速度还没oss快, 遂放弃. oss 中可以直接设置 cdn .
4 STS授权与URL授权
  - STS账户可以直接访问给定oss资源而无需经过后端处理, 需要前端添加相应代码
  - URL授权是经过后台控制的
  - URL授权需要解决在有效期内重新访问的问题

所以, 如果刚开始一步步做, 获取会轻松些吧. 但是, 一步登天, 给人NB的期望, 一步步, 却不会.

最终部署方案如下
1. 容器化服务, 且使用 docker-compose 管理docker.
  - 私有仓库是借助 阿里云容器服务 实现的.
  - 以后有需求了或有时间了, 可以试试 k8s 等工具
2. Nginx 反向代理
3. 阿里云免费ssl证书

docker-compose 参考
1. [nginx](./docker/nginx)
2. [后台服务server](./docker/xgxw-server)
